import torch
import torch.nn as nn

class SegmentationLosses(object):

	def __init__(self, weight=None, batch_average=True, ignore_index=255, cuda=True):
		
		self.ignore_index = ignore_index
		self.weight = weight
		self.batch_average = batch_average
		self.cuda = cuda


	def build_loss(self, mode='ce'):
		if mode == 'ce':
			return self.CrossEntropyLoss
		elif mode == 'focal':
			return self.FocalLoss
		else:
			raise NotImplementedError


	def SampleWeightedCrossEntropyLoss(self, logit, target, sample_weights):
		n, c, h, w = logit.size()
		criterion = nn.CrossEntropyLoss(weight=self.weight, ignore_index=self.ignore_index, reduction='none')

		if self.cuda:
			criterion = criterion.cuda()
			weights = sample_weights.cuda()

		loss = criterion(logit, target.long()).mean(-1).mean(-1)

		loss = torch.mean(torch.mul(loss, weights))

		if self.batch_average:
			loss /= n

		return loss

	def CrossEntropyLoss(self, logit, target):
		n, c, h, w = logit.size()
		criterion = nn.CrossEntropyLoss(weight=self.weight, ignore_index=self.ignore_index, reduction='mean')
		
		if self.cuda:
			criterion = criterion.cuda()

		loss = criterion(logit, target.long())

		if self.batch_average:
			loss /= n

		return loss


	def FocalLoss(self, logit, target, gamma=2, alpha=0.5):
		n, c, h, w = logit.size()
		criterion = nn.CrossEntropyLoss(weight=self.weight, ignore_index=self.ignore_index, reduction='mean')

		if self.cuda:
			criterion = criterion.cuda()

		logpt = -criterion(logit, target.long())
		pt = torch.exp(logpt)

		if alpha is not None:
			logpt *= alpha
		loss = -((1 - pt) ** gamma) * logpt

		if self.batch_average:
			loss /= n

		return loss
		

if __name__ == "__main__":
	
	loss = SegmentationLosses(cuda=True)
	a = torch.rand(2, 3, 7, 7).cuda()
	b = torch.rand(2, 7, 7).cuda()
	print(loss.CrossEntropyLoss(a, b).item())
	print(loss.FocalLoss(a, b, gamma=0, alpha=None).item())
	print(loss.FocalLoss(a, b, gamma=2, alpha=0.5).item())

	w = torch.FloatTensor([1, 1]).cuda()
	print(loss.SampleWeightedCrossEntropyLoss(a, b, w).item())
	w = torch.FloatTensor([1, 0]).cuda()
	print(loss.SampleWeightedCrossEntropyLoss(a, b, w).item())
	w = torch.FloatTensor([0, 1]).cuda()
	print(loss.SampleWeightedCrossEntropyLoss(a, b, w).item())
